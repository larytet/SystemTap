#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

CFLAGS = -Wall -g -D_GNU_SOURCE

ifneq (,$(filter noopt,$(DEB_BUILD_OPTIONS)))
	CFLAGS += -O0
else
	CFLAGS += -O2
endif
CXXFLAGS = $(CFLAGS)
export CFLAGS CXXFLAGS

ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	MAKEFLAGS += -j$(NUMJOBS)
endif

VIM_ADIR = $(CURDIR)/debian/tmp/usr/share/vim/addons
VIM_RDIR = $(CURDIR)/debian/tmp/usr/share/vim/registry

CONF_FLAGS = --enable-sqlite --disable-crash --enable-docs --disable-pie \
	     --enable-refdocs --enable-server --enable-grapher --without-rpm \
	     --enable-translator

# dh does it wrong...
CONF_FLAGS += --libexecdir=/usr/lib

DH = dh --with quilt

# TODO used $(DH) patch
patch:
	dh_quilt_patch

# plus is to enable parallel build
binary binary-arch binary-indep build clean install:
	+$(DH) $@

override_dh_auto_configure:
	AUTOMAKE=automake-1.11 ACLOCAL=aclocal-1.11 autoreconf -fiv
	dh_auto_configure -- $(CONF_FLAGS)

override_dh_auto_test:
	# Tests cannot be run during build, see #526957

override_dh_auto_install:
	dh_auto_install
	rm -r debian/tmp/usr/share/systemtap/tapset/test

	# Those files do not realy belong there
	rm debian/tmp/usr/share/doc/systemtap/examples/README
	rm debian/tmp/usr/share/doc/systemtap/examples/html/*.tmpl

	# make sure that all examples are executable (except tutorial)
	find debian/tmp/usr/share/doc/systemtap/examples/ -name \*.stp \! -executable -print -exec chmod +x "{}" \;
	
	# This file should got into both client and server package
	# But -server depends on -client
	mv debian/tmp/usr/share/man/man8/stap-server.8 debian/tmp/usr/share/man/man8/stap-client.8
	# This file does not document stap-server binary, so let's rename it
	# mv debian/tmp/usr/share/man/man8/stap-server.8 debian/tmp/usr/share/man/man8/stap-start-server.8
	# This is not really an executable
	chmod -x debian/tmp/usr/bin/stap-env

	# Install vim files
	install -d $(VIM_ADIR)/ftdetect
	install -d $(VIM_ADIR)/syntax
	install -d $(VIM_ADIR)/indent
	install -d $(VIM_ADIR)/ftplugin
	cp vim/filetype.vim $(VIM_ADIR)/ftdetect/stap.vim
	cp vim/syntax/stap.vim $(VIM_ADIR)/syntax/stap.vim
	cp vim/indent/stap.vim $(VIM_ADIR)/indent/stap.vim
	cp vim/ftplugin/stap.vim $(VIM_ADIR)/ftplugin/stap.vim
	install -d $(VIM_RDIR)
	cp $(CURDIR)/debian/systemtap.yaml $(VIM_RDIR)/

override_dh_auto_clean:
	dh_auto_clean
	find . . -regextype posix-awk \( \
		-name configure \
		-o -name aclocal.m4 \
		-o -name Makefile.in \
		-o -regex '.*/config.(cache|log|status|guess|sub)' \
		-o -name missing \
		-o -name compile \
	        -o -name install-sh \
		-o -name depcomp \
		-o -name mkinstalldirs \) -exec rm "{}" \;
	rm -f config.in

override_dh_compress:
	dh_compress -X.stp -X.wav -Xsocktop -Xsyscalltimes -X.pdf

override_dh_fixperms:
	dh_fixperms
	chmod 4755 debian/systemtap-runtime/usr/bin/staprun

.PHONY: build clean binary-indep binary-arch binary install patch
.PHONY: override_dh_auto_configure override_dh_auto_test override_dh_auto_install
.PHONY: override_dh_auto_clean override_dh_compress override_dh_fixperms
